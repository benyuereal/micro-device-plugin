# 修改后的 qwen-statefulset-local-direct.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: qwen-mini
spec:
  serviceName: "qwen-service"
  replicas: 2  # 增加副本数
  podManagementPolicy: OrderedReady
  selector:
    matchLabels:
      app: qwen
  template:
    metadata:
      labels:
        app: qwen
    spec:
      # 新增拓扑分布约束 - 核心修改点
      topologySpreadConstraints:
        - maxSkew: 2  # 节点间最大Pod数差异
          topologyKey: kubernetes.io/hostname  # 节点级别的拓扑域
          whenUnsatisfiable: DoNotSchedule  # 不满足条件时不调度
          labelSelector:
            matchLabels:
              app: qwen

      runtimeClassName: nvidia
      containers:
        - name: text-generation
          image: ghcr.io/huggingface/text-generation-inference:1.4.1
          command: ["text-generation-launcher"]
          args:
            - "--model-id"
            - "/model"
            - "--num-shard"
            - "1"
            - "--port"
            - "8000"
            - "--quantize"
            - "bitsandbytes"
          env:
            - name: TRANSFORMERS_OFFLINE
              value: "1"
            - name: HF_HUB_OFFLINE
              value: "1"
            - name: NVIDIA_DISABLE_REQUIRE
              value: "1"
          # 添加就绪探针，确保Pod完全启动后才被认为是就绪
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 5
            failureThreshold: 10
            timeoutSeconds: 5
          # 添加存活探针，确保应用健康
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 10
            failureThreshold: 3
            timeoutSeconds: 5
          resources:
            limits:
              nvidia.com/microgpu: 1
          ports:
            - containerPort: 8000
          volumeMounts:
            - name: model-storage
              mountPath: /model
      volumes:
        - name: model-storage
          hostPath:
            path: /home/Qwen1.5-0.5B-Chat
            type: Directory
  # StatefulSet更新策略
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0  # 确保有序更新

---
apiVersion: v1
kind: Service
metadata:
  name: qwen-service
spec:
  type: NodePort
  selector:
    app: qwen
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
      nodePort: 30080